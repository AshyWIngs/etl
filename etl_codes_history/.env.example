# file: .env.example

# --- PostgreSQL (журнал) ---
PG_DSN=postgresql://etl_user:password@10.254.3.91:5432/etl_database?connect_timeout=5&keepalives=1&keepalives_idle=30&keepalives_interval=10&keepalives_count=5
JOURNAL_TABLE=public.inc_processing
PROCESS_NAME=codes_history_increment
#JOURNAL_RETENTION_DAYS=1
JOURNAL_RETENTION_DAYS=1
# Авто‑чистка журнала в конце успешного запуска (1 — включено)
JOURNAL_AUTOPRUNE_ON_DONE=1
# Размер батча для prune_old() (сколько записей удаляем за один проход)
JOURNAL_PRUNE_BATCH_SIZE=20000
# Быстрый TCP-probe (мс) перед подключением к PG; 0 — выключено
PG_TCP_PROBE_TIMEOUT_MS=3000

# --- Phoenix ---
PQS_URL=http://10.254.3.112:8765
HBASE_MAIN_TABLE=TBL_JTI_TRACE_CIS_HISTORY
HBASE_MAIN_TS_COLUMN=opd
HBASE_MAIN_COLUMNS=c,t,opd,id,did,rid,rinn,rn,sid,sinn,sn,gt,prid,st,ste,elr,emd,apd,exd,p,pt,o,pn,b,tt,tm,ch,j,pg,et,pvad,ag
# Крупные чанки чтения, чтобы сократить количество roundtrip'ов к PQS
PHX_FETCHMANY_SIZE=20000
# 'timestamp'|'millis'|'micros' — для phoenixdb
PHX_TS_UNITS=timestamp
# Ранний TCP‑пробник перед phoenixdb.connect
PHOENIX_TCP_PROBE_TIMEOUT_MS=3000

# --- Управление логами и трейсбеком ---
# 0 — короткое сообщение без stacktrace; 1 — печатать полный stacktrace
ETL_TRACE_EXC=0
# DEBUG|INFO|WARNING|ERROR
LOG_LEVEL=INFO

# --- Грануляция и бизнес‑окна ---
# размер бизнес-слайда в минутах
STEP_MIN=10
# трактовка наивных CLI‑дат как локальных (Астана)
INPUT_TZ=business
BUSINESS_TZ=Asia/Almaty
# небольшой «захлёст» влево для первого слайда
PHX_QUERY_OVERLAP_MINUTES=5
PHX_OVERLAP_ONLY_FIRST_SLICE=1

# --- ClickHouse (только native:9000) ---
CH_HOSTS=10.254.3.111,10.254.3.112,10.254.3.113,10.254.3.114
CH_PORT=9000
CH_DB=stg
CH_USER=default
CH_PASSWORD=
CH_CLUSTER=shardless
# Таймзона для ПЕЧАТИ логов (не влияет на времена в БД)
JOURNAL_LOG_TZ=Asia/Almaty
# Таблицы (совместимо с вашей DDL):
# RAW (Distributed) — источник для дедупа
CH_RAW_TABLE=stg.daily_codes_history_raw_all
# «Чистая» таблица (реплицируемая)
CH_CLEAN_TABLE=stg.daily_codes_history
# Distributed над «чистой»
CH_CLEAN_ALL_TABLE=stg.daily_codes_history_all
# Буфер для дедупа (реплицируемая, БЕЗ TTL)
CH_DEDUP_BUF_TABLE=stg.daily_codes_history_dedup_buf
# Крупные батчи вставки в CH для высокой пропускной способности
CH_INSERT_BATCH=100000
CH_INSERT_MAX_RETRIES=1

# --- Каденс публикаций (дедуп/REPLACE) ---
# При STEP_MIN=10 это ≈ раз в час
PUBLISH_EVERY_SLICES=6
# Публиковать только если есть прирост в RAW
PUBLISH_ONLY_IF_NEW=1
PUBLISH_MIN_NEW_ROWS=1
# В конце запуска обязательно опубликовать оставшиеся партиции
ALWAYS_PUBLISH_AT_END=1