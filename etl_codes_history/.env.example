# file: .env.example

# --- PostgreSQL (журнал) ---
PG_DSN=postgresql://etl_user:password@10.254.3.91:5432/etl_database?connect_timeout=5&keepalives=1&keepalives_idle=30&keepalives_interval=10&keepalives_count=5
JOURNAL_TABLE=public.inc_processing
PROCESS_NAME=codes_history_increment
# Период/окно партиций журнала
JOURNAL_PARTITION_INTERVAL_DAYS=7
JOURNAL_PARTITION_BEHIND=1
JOURNAL_PARTITION_AHEAD=1
# «тихий» режим и троттлинг
JOURNAL_HEARTBEAT_MIN_INTERVAL_SEC=300
# Ретенция
JOURNAL_RETENTION_DAYS=7
# Таймзона печати логов
JOURNAL_LOG_TZ=Asia/Almaty
# Быстрый TCP-probe (мс) перед подключением к PG; 0 — выключено
PG_TCP_PROBE_TIMEOUT_MS=3000

# --- Phoenix ---
PQS_URL=http://10.254.3.112:8765
HBASE_MAIN_TABLE=TBL_JTI_TRACE_CIS_HISTORY
HBASE_MAIN_TS_COLUMN=opd
HBASE_MAIN_COLUMNS=c,t,opd,id,did,rid,rinn,rn,sid,sinn,sn,gt,prid,st,ste,elr,emd,apd,exd,p,pt,o,pn,b,tt,tm,ch,j,pg,et,pvad,ag
# Крупные чанки чтения, чтобы сократить количество roundtrip'ов к PQS
PHX_FETCHMANY_SIZE=5000
# Минимальный размер окна при делении, мин (по умолчанию 2)
PHX_OVERLOAD_MIN_SPLIT_MIN=2
# Максимальная глубина деления (по умолчанию 3)
PHX_OVERLOAD_MAX_DEPTH=3
# Сколько ретраев, если делить уже нельзя (по умолчанию 3)
PHX_OVERLOAD_RETRY_ATTEMPTS=3
# Базовая задержка ретраев, мс (по умолчанию 700)
PHX_OVERLOAD_RETRY_BASE_MS=700
# Убирает ORDER BY - 1|true|yes
PHX_DISABLE_ORDER_BY=1
# Фиксированный «начальный» размер слайса окна в минутах.
# Если > 0, то исходный интервал сначала нарезается на срезы указанной длины,
# и каждый срез читается отдельно (сверху всё равно действует адаптивное деление при перегрузке).
# По умолчанию 5 (5 минут)
PHX_INITIAL_SLICE_MIN=5
# Ранний TCP‑пробник перед phoenixdb.connect
PHX_TCP_PROBE_TIMEOUT_MS=3000

# --- Управление логами и трейсбеком ---
# 0 — короткое сообщение без stacktrace; 1 — печатать полный stacktrace
ETL_TRACE_EXC=0
# DEBUG|INFO|WARNING|ERROR
LOG_LEVEL=INFO

# --- ETL окно по умолчанию (часы), когда --until не указан ---
RUN_WINDOW_HOURS=24

# --- Грануляция и бизнес‑окна ---
# размер бизнес-слайда в минутах
STEP_MIN=10
# трактовка наивных CLI‑дат как локальных (Астана)
BUSINESS_TZ=Asia/Almaty
# небольшой «захлёст» влево для первого слайда
PHX_QUERY_OVERLAP_MINUTES=5

# --- ClickHouse (только native:9000) ---
CH_HOSTS=10.254.3.111,10.254.3.112,10.254.3.113,10.254.3.114
CH_PORT=9000
CH_DB=stg
CH_USER=default
CH_PASSWORD=
CH_CLUSTER=shardless
# Таймзона для ПЕЧАТИ логов (не влияет на времена в БД)
JOURNAL_LOG_TZ=Asia/Almaty
# Таблицы (совместимо с вашей DDL):
# RAW (Distributed) — источник для дедупа
CH_RAW_TABLE=stg.daily_codes_history_raw_all
# «Чистая» таблица (реплицируемая)
CH_CLEAN_TABLE=stg.daily_codes_history
# Distributed над «чистой»
CH_CLEAN_ALL_TABLE=stg.daily_codes_history_all
# Буфер для дедупа (реплицируемая, БЕЗ TTL)
CH_DEDUP_BUF_TABLE=stg.daily_codes_history_dedup_buf
# Крупные батчи вставки в CH для высокой пропускной способности
CH_INSERT_BATCH=100000
CH_INSERT_MAX_RETRIES=1

# --- Каденс публикаций (дедуп/REPLACE) ---
# При STEP_MIN=10 это ≈ раз в час
PUBLISH_EVERY_SLICES=6
# Публиковать только если есть прирост в RAW
PUBLISH_ONLY_IF_NEW=1
PUBLISH_MIN_NEW_ROWS=1
# В конце запуска обязательно опубликовать оставшиеся партиции
ALWAYS_PUBLISH_AT_END=1
STARTUP_BACKFILL_DAYS=3